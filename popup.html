<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="css/popup.css" type="text/css">	
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<script>
	var apiKey = "2bfe0f77271c33930848bf6976cd7bab",
		username = "freak2532";
		
	function getReleases() {
		$.ajax({
			type: 'get',
			url: "http://ws.audioscrobbler.com/2.0/?method=user.getnewreleases&format=json&user="+username+"&api_key="+apiKey,
			dataType: 'json',
			async: false,
			success: function(data) {
				html = '';
				if(data != null){
					aAlbums = new Array();
					console.log(data);
					if(data.albums.album instanceof Array)
						aAlbums = data.albums.album;
					else
						aAlbums = [data.albums.album];

					$.each(aAlbums, function(i,item){
						albumInfo = getAlbumInfo(item.artist.name, item.name);
						buyLinks = getBuyLinks(item.artist.name, item.name);
						
						html += '<article>';
						html += '<figure><img src="'+item.image[1]["#text"]+'" alt=""></figure>';
						html += '<h3><a href="'+item.url+'" title="'+item.name+'">'+item.name+'</a></h3>';
						html += '<h4><a href="'+item.artist.url+'" title="'+item.artist.name+'">'+item.artist.name+'</a></h4>';
						html += '<p>Released on '+item["@attr"].releasedate+'</p>';
						html += '</article>';
					});
					$('#newReleases').html(html);
				}
			}
		});
	}
	
	function getAlbumInfo(artist, album) {
		var albumInfo;
		$.ajax({
			type: 'get',
			url: "http://ws.audioscrobbler.com/2.0/?method=album.getinfo&format=json&api_key="+apiKey+"&artist="+encodeURI(artist)+"&album="+encodeURI(album),
			dataType: 'json',
			async: false,
			success: function(data) {
				if(data != null){
					// get album info using the following:
					// data.album.playcount
					// data.album.listeners
					albumInfo = data.album;
				}
			}
		});
		return albumInfo;
	}
	
	function getBuyLinks(artist, album) {
		var buyLinks = [];
		$.ajax({
			type: 'get',
			url: "http://ws.audioscrobbler.com/2.0/?method=album.getbuylinks&format=json&artist="+encodeURI(artist)+"&album="+encodeURI(album)+"&country=united%20states&api_key="+apiKey,
			dataType: 'json',
			async: false,
			success: function(data) {
				if(data != null){
					$.each(data.affiliations.downloads.affiliation, function(i,item){
						// create buy links for each album using the following:
						// item.buyLink
						// item.supplierIcon
						// item.supplierName
						buyLinks[i] = item;
					});
				}
			}
		});
		return buyLinks;
	}
		
	$(document).ready(function() {getReleases();});
	</script>
</head>
<body>
	<div id="wrapper">
		<header>
			<h1><img src="images/lastfm_red.png" alt="Last.fm"></h1>
			<h2>New Releases</h2>
		</header>

		<section id="newReleases">		
			<article>
				<p>Loading New Releases...</p>
			</article>
		</section>

		<footer>
			<p>Developed by <a href="http://jamesfleeting.com" title="James Fleeting Is Awesome" target="_blank">James Fleeting</a> of <a href="http://monkeecreate.com" title="monkeeCreate" target="_blank">monkeeCreate</a><br />
				Not affiliated in any way with last.fm</p>
		</footer>
	</div>
</body>
</html>